@using QuanLyGaraOto.Models;
@model QuanLyGaraOto.ViewModel.PhieuDVViewModel
@{
    Layout = "~/Views/Layout/_GeneralLayout.cshtml";
    //List<TIENCONG> listtc = ViewBag.ListTienCong;
    int slTon = 0;
    decimal dongia = 0;
    string sdt = "";
    if(Model.ListTho.Count >0)
    {
        sdt = Model.ListTho[0].SDT;
    }
    if(Model.ListPhuTung.Count >0)
    { 
        slTon = Model.ListPhuTung[0].SOLUONGTON.Value;
        dongia = Math.Round(Model.ListPhuTung[0].DONGIAXUAT.Value);
    }
    //string txt = "faasdf";
    //string val = "fadsd";
    int val = 2;
}
<!DOCTYPE html>
<style>
    .table th {
        width: auto !important;
    }

    .table {
        font-size: small;
    }

    .form-group {
        margin-bottom: 5px;
    }
</style>

@using (@Html.BeginForm("NhapPhieuDichVu", "PhieuDichVu", FormMethod.Post, new { @class = "form-horizontal" }))
{
    
    <input type="hidden" name="PhieuDichVu.MA_NHANVIEN" value="@Model.PhieuDichVu.MA_NHANVIEN" />
    <input type="hidden" name="PhieuDichVu.MAPHIEU_TIEPNHAN" value="@Model.PhieuDichVu.MAPHIEU_TIEPNHAN" />
    <div class="form-group form-inline">
        <label class="input-sm">Mã phiếu:</label>
        <input type="text" name="PhieuDichVu.MA_PHIEUDV" value="" class="form-control input-sm"/>
    </div>
    <div class="form-group">
        <label class="input-sm">Ngày lập:</label>
        <label class="input-sm">@Model.NgayLap.Date</label>
        
    </div>

    <div class="form-group">
        <label class="input-sm">Người lập:</label>
        <label class="input-sm">@Model.TenNV</label>
       
    </div>

    <div class="form-group">
        <label class="input-sm">Chủ xe:</label>
        <label class="input-sm">@Model.TenKH</label>
    </div>


    <div class="form-group form-inline">
        <label class="input-sm">Thợ phụ trách:</label>
        <select name="PhieuDichVu.MATHO" class="cboTho form-control input-sm" onchange="cboThoSelectChanged()">
            @foreach (var item in Model.ListTho)
            {
                <option value="@item.MA_THO" title="@item.SDT">@item.TENTHO</option>
            }
        </select>
        <label class="input-sm">Số điện thoại:</label>
        <label class="lblSDT input-sm ">@sdt</label>
    </div>
    <div class="form-group form-inline">
        <label class="input-sm">Tiền công:</label>
        <input class="txtTienCong form-control input-sm" type="number" min="1000" max="10000" name="PhieuDichVu.TIENCONG" />
    </div>
    <div class="panel panel-default" style="width:99%;">
        <div class="panel-heading">Thông tin chi tiết:</div>
        <div class="panel-body">
            <div class=" form-group form-inline" style="padding-left:5px;">

                <label class="input-sm">Phụ tùng:</label>
                <select id="cbo" class="cboPT form-control input-sm" style="width:12%" onchange="cboPTSelectChanged()">
                    @foreach (var item in Model.ListPhuTung)
                    {
                        <option value="@item.MA_PHUTUNG" title="@item.SOLUONGTON" itemprop="@item.DONGIAXUAT">@item.TEN_PHUTUNG</option>
                    }
                </select>


                <label class="input-sm">Lượng tồn:</label>
                <label class="lblTonKho input-sm" style="width:4%">@slTon</label>
                <label class="input-sm">Số lượng:</label>
                <input type="number" maxlength="3" pattern="[0-9]"  class=" txtSoLuong form-control input-sm" style="width:8%" />
                <label class="input-sm">Đơn giá:</label>
                <input type="number" maxlength="8"  pattern="[0-9]" class="txtDonGia form-control input-sm" style="width:10%" value="@dongia" readonly/>
                <label class="input-sm">Bảo hành:</label>
                <input type="number" maxlength="2"  pattern="[0-9]" class="txtBH form-control input-sm" style="width:6%;" />
                <label class="input-sm">Thành tiền:</label>
                <label class="lblThanhTien input-sm" style="width:10%"></label>

            </div>
            <div class="form-inline">
                <input type="button" value="Thêm chi tiết" class="btn btn-success" id="btnAdd" />


            </div>
            <div class="table-responsive" style="padding-top:10px; margin-right:20px;">
                <table id="chitietphieu-table" class="table table-bordered table table-hover ">
                    @*<thead style="color:red;">*@
                    <tr class="trFirstRow" style="color:red;" data-id="-1">
                        <th style="display:none">Id</th>
                        <th>Phụ tùng</th>

                        <th>Số lượng</th>
                        <th>Đơn giá</th>
   
                        <th>Thành tiền</th>
                        <th>Thời gian bảo hành (tháng)</th>
                        <th>Thao tác</th>
                    </tr>
                    @*  </thead>*@
                    <tbody>
                        <tr class="record-template" style="display:none">
                            <td style="display:none;">
                                <input type="hidden" class="maPDV" name="ID_PHIEUDV" value="@Model.PhieuDichVu.ID_PHIEUDV" />
                            </td>
                            <td style="display:none;">
                                <input type="hidden" class="maPT" name="MA_PT" value="" />
                            </td>
                            <td>
                                <input class="txtTenPT form-control input-sm" type="text" value="" disabled />

                            </td>
                            <td>
                                <input type="text" class="txtSoluong form-control input-sm" name="SOLUONG" value="" readonly @*disabled*@ />

                            </td>
                            <td>
                                <input type="text" class="txtDonGia form-control input-sm" name="DONGIA" value="" readonly @*disabled*@ />
                            </td>

                            <td>
                                <input type="text" class=" txtThanhTien form-control input-sm" name="THANHTIEN" value="" readonly @*disable*@ d />
                            </td>
                            <td>
                                <input type="text" class="txtBaoHanh form-control input-sm" name="THOIHAN_BAOHANH" value="" readonly @*disabled*@ />
                            </td>
                            <td>
                                <input type="button" value="Xóa" class="btn btn-danger" id="btnDelete" />
                            </td>
                        </tr>

                    </tbody>

                </table>

            </div>
            <div class="form-group" style="padding-left:10px;">

                <button class="btn btn-primary" type="submit">Lưu</button>
            </div>
        </div>

    </div>
}
<script>
    @*$('document').ready(function () {
        //$(".cboTC").val("2");
        //$(".cboTC option[value='2']").attr("selected", true);
        $('.cboTho').val('@val').prop('selected', true);
    })*@
    $('#chitietphieu-table').on('click', '.clickable-row', function (event) {
        if ($(this).hasClass('active')) {
            $(this).removeClass('active');
        } else {
            $(this).addClass('active').siblings().removeClass('active');
        }
    });
    $("form").submit(function (e)
    {
        var rowCount = $("#chitietphieu-table tr").length;
        var numberofContentRow = parseInt(rowCount - 2);
        //alert(numberofContentRow);
        if (numberofContentRow == 0)
        {
            alert("Vui lòng nhập dữ liệu vào bảng chi tiết!");
            e.preventDefault();
        }
        //alert("method call");
        //e.preventDefault();
        //alert("stop submit");
    })
    $("body").delegate("#btnDelete", "click", function () {
        var row = $(this).closest("tr");
        var soluong = row.find("input.txtSoluong").attr("value");
        var phutung = row.find("input.maPT").attr("value");


        var conlai = parseInt($('select.cboPT option[value="' + phutung + '"]').attr("title"));
        var tongso = parseInt(conlai) + parseInt(soluong);
        $('select.cboPT option[value="' + phutung + '"]').attr("title",tongso)

        row.remove();
        CapNhapID();

    });
    function cboThoSelectChanged()
    {
        var SDT = $('.cboTho').children("option").filter(":selected").attr("title");
        $('.lblSDT').text(SDT);

    }
    function cboPTSelectChanged()
    {
        @*var option = document.createElement("option");
        option.text = '@txt.ToString()';
        option.value = '@val.ToString()';
        var select = document.getElementById("cbo");
        select.appendChild(option);*@
        var tonkho = $('.cboPT').children("option").filter(":selected").attr("title");
        var dongia = $('.cboPT').children("option").filter(":selected").attr("itemprop");
        
       // alert(mapt);
        $('.lblTonKho').text(parseInt(tonkho));
        $('.txtDonGia').val(parseInt(dongia));
    }

        $('.txtDonGia').on('input',function(e)
        {
            var soluong = parseInt($('input.txtSoLuong').val());

            var dongia = parseInt($('input.txtDonGia').val());
            //var tiencong = $('.cboTC').children("option").filter(":selected").attr("title");
            var tien = soluong * dongia;
            var thanhtien = parseInt(tien);// + parseInt(tiencong);
            $('.lblThanhTien').text('');
            $('.lblThanhTien').text(parseInt(thanhtien));
        })
            
        $('.txtSoLuong').on('input', function (e)
        {
            var soluong = parseInt($('input.txtSoLuong').val());
     
            var dongia = parseInt($('input.txtDonGia').val());
            var tiencong = $('.cboTC').children("option").filter(":selected").attr("title");
            var tien = soluong * dongia;
            var thanhtien = parseInt(tien) + parseInt(tiencong);
            $('.lblThanhTien').text('');
            $('.lblThanhTien').text(parseInt(thanhtien));
            //alert('text changed');
        })
        $("#btnAdd").click(function () {
            var tonkho = parseInt($('.cboPT').children("option").filter(":selected").attr("title"));
            var soluong = parseInt($('input.txtSoLuong').val());

            var dongia = parseInt($('input.txtDonGia').val());
            var baohanh = parseInt($('input.txtBH').val());
            
            if (isNaN(dongia) == true) {
                alert("Đơn giá không được để trống!")
                return;
            }
            if (isNaN(soluong) == true) {
                alert("Số lượng không được để trống!")
                return;
            }
            if (isNaN(baohanh) == true) {
                alert("Hạn bảo hành không được để trống!")
                return;
            }
            if (dongia <= 0) {
                alert("Nhập sai đơn giá!")
                return;
            }
            if (baohanh <= 0) {
                alert("Nhập sai hạn bảo hành!")
                return;
            }
            if (soluong <= 0) {
                alert("Nhập sai số lượng!")
                return;
            }
            else {
                if (soluong > tonkho) {
                    alert("Số lượng cần vượt quá lượng tồn trong kho!")
                    return;
                }
                var conlai = tonkho - soluong;
                $('.cboPT').children("option").filter(":selected").attr("title", conlai)
                $('.lblTonKho').text(conlai);
            }

           

                
            var id_cuoi = $("#chitietphieu-table").find("tr:last-child").attr("data-id");
            //alert(id_cuoi);
            i = parseInt(id_cuoi) + 1;
            //alert(i);
            var tdnoidung = $(".record-template").html();

            var trnoidung = "<tr class=\"record-template\" data-id=\"" + i + "\">" + tdnoidung + "</tr>";
            $("#chitietphieu-table").append(trnoidung);

            //var tiencong = $('.cboTC').children("option").filter(":selected").attr("title");

            //var matiencong = $('.cboTC').children("option").filter(":selected").attr("value");

            //var $matiencong = $("#chitietphieu-table").find("tr:last-child").find('td input.maTC')
            //$matiencong.attr("value", matiencong);

            var maphutung = $('.cboPT').children("option").filter(":selected").attr("value");
            var $maphutung = $("#chitietphieu-table").find("tr:last-child").find('td input.maPT');
         
            $maphutung.attr("value", maphutung);
            
            var tenpt = $('.cboPT').children("option").filter(":selected").text();
            
            var $tenphutung = $("#chitietphieu-table").find("tr:last-child").find('td input.txtTenPT');
            $tenphutung.attr("value", tenpt);
            
            //var loaitiencong = $('.cboTC').children("option").filter(":selected").attr("value");
            //var $tentiencong = $("#chitietphieu-table").find("tr:last-child").find('td input.txtTenTC');
            //$tentiencong.attr("value", loaitiencong);

            var $txtsoluong = $("#chitietphieu-table").find("tr:last-child").find('td input.txtSoluong');
          
            $txtsoluong.attr("value", soluong);

            var $txtdongia = $("#chitietphieu-table").find("tr:last-child").find('td input.txtDonGia');
            $txtdongia.attr("value", dongia);
        
            //var $txttiencong = $("#chitietphieu-table").find("tr:last-child").find('td input.txtTienCong');
            //$txttiencong.attr("value", tiencong);

            var thanhtien = parseInt(soluong * dongia);
            alert(thanhtien);
            var $txtthanhtien = $("#chitietphieu-table").find("tr:last-child").find('td input.txtThanhTien');
            $txtthanhtien.attr("value", thanhtien);
            var baohanh = $('.txtBH').val();
            var $txtbaohanh = $("#chitietphieu-table").find("tr:last-child").find('td input.txtBaoHanh');
            $txtbaohanh.attr("value", baohanh);
            loadIDLENTHE();

        });

        function loadIDLENTHE() {
            $(".record-template").each(function () {

                var id = $(this).attr("data-id");
                var nameDV = "[" + id + "].MA_PHIEUDV";
                var nameMaPhuTung = "[" + id + "].MA_PT";
                //var nameMaTienCong = "[" + id + "].MA_TIENCONG";

                var nameSoLuong = "[" + id + "].SOLUONG";
                var nameDonGia = "[" + id + "].DONGIA";
                //var nameTienCong = "[" + id + "].TIENCONG";
                var nameThanhTien = "[" + id + "].THANHTIEN";
                var nameThoiHanBaoHanh = "[" + id + "].THOIHAN_BAOHANH"

                $(this).find(".maPDV").attr("name", nameDV);
                $(this).find(".maPT").attr("name", nameMaPhuTung);
                //$(this).find(".maTC").attr("name", nameMaTienCong);
                $(this).find(".txtSoluong").attr("name", nameSoLuong);
                $(this).find(".txtDonGia").attr("name", nameDonGia);
                //$(this).find(".txtTienCong").attr("name", nameTienCong);
                $(this).find(".txtThanhTien").attr("name", nameThanhTien);
                $(this).find(".txtBaoHanh").attr("name", nameThoiHanBaoHanh);

            })
        };

        function CapNhapID() {
            var id_cuoi = $("#chitietphieu-table").find(".trFirstRow").attr("data-id");
            i = parseInt(id_cuoi) + 1;

            $(".record-template").each(function () {
                var id = i;
                $(this).attr("data-id", i);
                var nameDV = "[" + id + "].MA_PHIEUDV";
                var nameMaPhuTung = "[" + id + "].MA_PT";
                //var nameMaTienCong = "[" + id + "].MA_TIENCONG";

                var nameSoLuong = "[" + id + "].SOLUONG";
                var nameDonGia = "[" + id + "].DONGIA";
                var nameTienCong = "[" + id + "].TIENCONG";
                var nameThanhTien = "[" + id + "].THANHTIEN";
                var nameThoiHanBaoHanh = "[" + id + "].THOIHAN_BAOHANH"

                $(this).find(".maPDV").attr("name", nameDV);
                $(this).find(".maPT").attr("name", nameMaPhuTung);
                //$(this).find(".maTC").attr("name", nameMaTienCong);
                $(this).find(".txtSoluong").attr("name", nameSoLuong);
                $(this).find(".txtDonGia").attr("name", nameDonGia);
                //$(this).find(".txtTienCong").attr("name", nameTienCong);
                $(this).find(".txtThanhTien").attr("name", nameThanhTien);
                $(this).find(".txtBaoHanh").attr("name", nameThoiHanBaoHanh);

                i++;
            })
        }
</script>

